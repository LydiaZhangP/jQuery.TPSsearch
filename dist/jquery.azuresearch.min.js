!function(e){var a={azureSearch:{url:"",key:""},googleGeocodeApi:{key:null,url:"https://maps.googleapis.com/maps/api/geocode/json",language:"en"},geoSearch:{lat:null,lng:null,fieldName:"_distance",azureFieldName:null,unit:"K",maxDistance:null},searchParms:{search:"*",facets:[],count:!0,top:50,skip:0,filter:null,orderby:null},facets:{facet:'<a href="#"/>',facetClass:"facet",titleWrapper:"<h2/>",title:'<a href="#"/>',titleClass:"",titleOnClick:function(){},titleWrapperClass:"facet-title",container:"#facets",wrapperContainer:"<ul/>",wrapperContainerClass:"facet-list",wrapper:"<li/>",wrapperClass:"facet-item",showCount:!0,countWrapper:null,countWrapperClass:null,facetOnClick:function(t){t.preventDefault();var r=e(this).data("azuresearchFacetName")+"|"+e(this).data("azuresearchFacetValue");if(-1!=a.facetsSelected.indexOf(r))return;a.facetsSelected.push(r),a.facetsApplied.onChange.call(a.facetsSelected.slice(0)),a.facets.onFacetSelect.call(a.facetsSelected.slice(0)),c()},searchMode:"and",onFacetSelect:function(){var t=a.facetsApplied;if(!t.container)return;var r=this.pop(),s=e(t.container),l=r.split("|");if(-1!=t.ignoreFacets.indexOf(l[0]))return;s.find('.selected-facets-group[data-az-field="'+l[0]+'"]').length>0?cc=s.find('.selected-facets-group[data-az-field="'+l[0]+'"]'):(cc=e("<div/>").addClass("selected-facets-group").attr("data-az-field",l[0]).appendTo(s),cc_title=a.facetsDictionary&&a.facetsDictionary[l[0]]?a.facetsDictionary[l[0]]:v,cc_titleElem=e("<span/>").addClass("selected-facets-group-title").text(cc_title).appendTo(cc));e("<a/>").text(l[1]).attr({href:"#"}).attr(t.extraAttributes).data("value",r).addClass(t.class).on("click",function(){a.facetsSelected.splice(a.facetsSelected.indexOf(e(this).data("value")),1),a.facetsApplied.onChange.call(a.facetsSelected.slice(0)),e(this).parent('.selected-facets-group[data-az-field="'+l[0]+'"]').children(".selected-facet").length<=1?e(this).parent('.selected-facets-group[data-az-field="'+l[0]+'"]').remove():e(this).remove(),c()}).appendTo(cc)},groupWrapper:"<div/>",groupWrapperClass:"group",emptyFacetText:"(none)"},facetsApplied:{container:null,class:"selected-facet",extraAttributes:{},ignoreFacets:[],onChange:function(){}},facetsDictionary:null,facetsSelected:[],results:{container:"#results",template:null,onCreate:function(){},alwaysClearContainer:!1},urlParameters:{address:"a",latitude:"l",longitude:"ln",latlong:null,search:"q"},onResults:function(){(function(t){var r=a.facets,c=e(r.container);if(!c||!t["@search.facets"])return;c.html(""),e(a.searchParms.facets).each(function(s,l){if(-1!=l.indexOf(",")&&(l=l.split(",")[0]),t["@search.facets"][l]){var n=a.facetsDictionary&&a.facetsDictionary[l]?a.facetsDictionary[l]:l,o=e(r.title).addClass(r.titleClass).text(n);r.titleWrapper&&(o=e(r.titleWrapper).addClass(r.titleWrapperClass).append(o)),c.append(o),o.on("click",r.titleOnClick);var i=e(r.wrapperContainer).addClass(r.wrapperContainerClass);c.append(i);var d=0;if(e(t["@search.facets"][l]).each(function(t,c){var s=""!=c.value?c.value:r.emptyFacetText,n=e(r.facet).addClass(r.facetClass).html(s).on("click",r.facetOnClick).data("azuresearchFacetName",l).data("azuresearchFacetValue",c.value);if(r.showCount&&a.facets.countWrapper?e(a.facets.countWrapper).text("("+c.count+")").addClass(a.facets.countWrapperClass).appendTo(n):r.showCount&&n.append(" ("+c.count+")"),-1!=a.facetsSelected.indexOf(l+"|"+c.value))return!0;r.wrapper?e(r.wrapper).addClass(r.wrapperClass).append(n).appendTo(i):i.append(n),d++}),r.groupWrapper){var p=e(r.groupWrapper).addClass(r.groupWrapperClass);c.append(p),o.appendTo(p),i.appendTo(p)}0==d&&o.remove()}})})(this),function(r){var c=a.results,s=e(c.container);if(!s||!r.value)return;(c.alwaysClearContainer||0==a.searchParms.skip)&&s.html("");e(r.value).each(function(r,l){if(c.template){var n=e(c.template);e(':not([data-azuresearch-field=""])',n).each(function(r,c){var s=e(c).data("azuresearchField"),n="";if(s&&l[s])n=l[s];else if(s==a.geoSearch.fieldName&&t.isGeoSearch&&l[a.geoSearch.azureFieldName]){var o=l[a.geoSearch.azureFieldName];n=function(e,a,t,r,c){var s=Math.PI*e/180,l=Math.PI*t/180,n=a-r,o=Math.PI*n/180,i=Math.sin(s)*Math.sin(l)+Math.cos(s)*Math.cos(l)*Math.cos(o);i>1&&(i=1);i=60*(i=180*(i=Math.acos(i))/Math.PI)*1.1515,"K"==c&&(i*=1.609344);"N"==c&&(i*=.8684);return i}(a.geoSearch.lat,a.geoSearch.lng,o.coordinates[1],o.coordinates[0],a.geoSearch.unit)}var i=e(c).data("azuresearchValueFormat");i&&window[i]&&(n=window[i](n,l)),s&&e(c).html(n)}),s.append(n),c.onCreate.call(n)}else{var o=e("<dl/>");e(Object.keys(l)).each(function(a,t){if(!l[t]||""==l[t])return!0;e("<dt/>").text(t).appendTo(o),e("<dd/>").text(l[t]).appendTo(o)}),o.appendTo(s),c.onCreate.call(o)}})}(this),a.onLoad.call(this,t)},onLoad:function(){},debug:!1},t={waitingLatLong:!1,isGeoSearch:!1,totalResults:0,initialized:!1};function r(e){s("Google Geocode return:"),s(e);"OK"==e.status&&e.results.length>0&&(a.geoSearch.lat=e.results[0].geometry.location.lat,a.geoSearch.lng=e.results[0].geometry.location.lng),t.waitingLatLong=!1,c()}function c(){if(t.isGeoSearch=!1,!t.waitingLatLong){if(a.geoSearch.lat&&a.geoSearch.lng&&(s("Geo searching..."),s(a.geoSearch.lat),s(a.geoSearch.lng),t.isGeoSearch=!0,!a.searchParms.orderby||0==a.searchParms.orderby.indexOf(a.geoSearch.fieldName))){var r="geo.distance("+a.geoSearch.azureFieldName;r+=", geography'POINT("+a.geoSearch.lng+" "+a.geoSearch.lat+")')",a.searchParms.orderby&&-1!=a.searchParms.orderby.indexOf(" desc")&&(r+=" desc"),a.searchParms.orderby=r}var c=null,l=a.searchParms.filter;if(a.facetsSelected.length>0){var n=[];a.facetsSelected.forEach(function(e,a){var t=e.split("|");n.push(t[0]+"/any(m: m eq '"+t[1].replace(/[']/gi,"''")+"')")}),c=n.join(" "+a.facets.searchMode+" "),l&&(c=a.searchParms.filter+" "+a.facets.searchMode+" "+c)}if(t.isGeoSearch&&a.geoSearch.maxDistance){s("Filter Geo searching by distance : "+a.geoSearch.maxDistance);var o="geo.distance("+a.geoSearch.azureFieldName+", geography'POINT("+a.geoSearch.lng+" "+a.geoSearch.lat+")') le "+a.geoSearch.maxDistance;c?c+=" "+a.facets.searchMode+" "+o:(c=o,l&&(c=a.searchParms.filter+" "+a.facets.searchMode+" "+c))}c&&(a.searchParms.filter=c);var i={crossDomain:!0,url:a.azureSearch.url,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","api-key":a.azureSearch.key,"Cache-Control":"no-cache"},data:JSON.stringify(a.searchParms)};e.ajax(i).done(function(e){t.totalResults=a.searchParms.count&&e["@odata.count"]?e["@odata.count"]:-1,a.onResults.call(e,t)}),a.searchParms.filter=l}}function s(e){a.debug&&window.console&&window.console.log&&window.console.log(e)}function l(e){if(!e)return null;var a,t,r=decodeURIComponent(window.location.search.substring(1)).split("&");for(t=0;t<r.length;t++)if((a=r[t].split("="))[0]===e)return void 0===a[1]||a[1];return null}e.fn.azuresearch=function(s,n){switch(n||(n="search"),s&&(s.googleGeocodeApi&&(s.googleGeocodeApi=e.extend(a.googleGeocodeApi,s.googleGeocodeApi)),s.searchParms&&(s.searchParms=e.extend(a.searchParms,s.searchParms)),s.facets&&(s.facets=e.extend(a.facets,s.facets)),s.facetsApplied&&(s.facetsApplied=e.extend(a.facetsApplied,s.facetsApplied)),s.results&&(s.results=e.extend(a.results,s.results)),s.geoSearch&&(s.geoSearch=e.extend(a.geoSearch,s.geoSearch)),s.urlParameters&&(s.urlParameters=e.extend(a.urlParameters,s.urlParameters)),a=e.extend(a,s),function(){var c=a.urlParameters,s=l(c.address),n=l(c.latitude),o=l(c.longitude),i=l(c.latlong),d=l(c.search);i&&-1!=i.indexOf(",")&&(n=i.split(",")[0],o=i.split(",")[1]);d&&(a.searchParms.search=d);n&&o&&(a.geoSearch.lat=n,a.geoSearch.lng=o);if(s&&!n&&!o&&!i){var p=function(c){var s=a.googleGeocodeApi;if(!s.key)return;t.waitingLatLong=!0;var l=s.url;l+=-1!=l.indexOf("?")?"&":"?",l+="key="+s.key,l+="&address="+c,l+="&language="+s.language,e.getJSON(l,r)}(s);p&&(n=p[0],o=p[1])}}()),t.initialized||e(a.facetsSelected).each(function(e,t){a.facets.onFacetSelect.call([t])}),n){case"search":c();break;case"resetFacets":a.facetsSelected=[],a.facets.onFacetSelect.call(a.facetsSelected),c()}return t.initialized=!0,this}}(jQuery);